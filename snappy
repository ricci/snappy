#!/usr/bin/env python3

import arrow
import sys
import re
from subprocess import check_output

zfsmap = { }
snapshots = { }
places = { }
paths = { }

class Place:
    def __init__(self,name,path):
        self._name = name
        self._path = path
        places[name] = self
        paths[path] = self

    def place(self):
        return self._name

    def path(self):
        return self._path

Place("test", "/test")

class Snapshot:
    def isSnappy(snap):
        return re.match(r"snappy-\d+",snap)

    def __init__(self,place,stamp):
        self._place = place
        self._stamp = stamp
        self._zfs = None
        self._tarsnap = None
        if not place in snapshots:
            snapshots[place] = { }
        snapshots[place][stamp] = self
        
    def hasZFS(self):
        return (self._zfs is not None)

    def setZFS(self,zfsname):
        self._zfs = zfsname

    def hasTarsnap(self):
        return (self._tarsnap is not None)

    def printListing(self):
        print("%s %s %s" % (self._stamp, self._zfs, self._tarsnap))

    def factory(place,stamp):
        print("Factory %s %s" % (place, stamp))
        if place in snapshots and stamp in snapshots[place]:
            return snapshots[place][stamp]
        else:
            return Snapshot(place,stamp)

def initZFS():
    zfsout = check_output(["/sbin/zfs","list","-Hp"])
    for line in iter(zfsout.splitlines()):
        arr = line.decode('utf-8').split()
        path, dataset = arr[4],arr[0]
        zfsmap[path] = dataset
        zfsmap[dataset] = path

    zfsout = check_output(["/sbin/zfs","list","-Hp","-t","snap"])
    for line in iter(zfsout.splitlines()):
        arr = line.decode('utf-8').split()
        snapname = arr[0]
        dataset,snap = snapname.split('@')
        if Snapshot.isSnappy(snap) and dataset in zfsmap and zfsmap[dataset] in paths.keys():
            newsnapshot = Snapshot.factory(paths[zfsmap[dataset]].place(), snap)
            newsnapshot.setZFS(snapname)

def initTarsnap():
    tarsnapout = None

def list():
    initZFS()
    for name, place in places.items():
        print("***** %s (%s)" % (name,place.path()))
        for stamp, snapshot in snapshots[name].items():
            snapshot.printListing()

def usage():
    print("snappy list")
    exit(1)


commands = { 'list' : list, 'usage' : usage }

if len(sys.argv) < 2:
    usage()
else:
    commands.get(sys.argv[1], usage)()
